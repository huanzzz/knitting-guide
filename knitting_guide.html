<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编织指导</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="section title-section">
            <span id="pattern-title">加载中...</span>
        </div>

        <div class="section text-section">
            <h3>编织说明</h3>
            <div id="instructions"></div>
        </div>

        <div class="section pattern-section">
            <h3>图解</h3>
            <div id="pattern"></div>
        </div>

        <div class="section counter-section">
            <button class="counter-button" onclick="decrementRow()" id="decrementButton">-</button>
            <div class="counter-number" id="row-counter">1</div>
            <button class="counter-button" onclick="incrementRow()" id="incrementButton">+</button>
        </div>
    </div>

    <script src="stitch_config.js"></script>
    <script>
        let currentRow = 1;
        let patternData = null;
        let instructionLines = [];

        // 加载编织数据
        async function loadKnittingData() {
            try {
                const response = await fetch('knitting_data.json');
                if (!response.ok) {
                    throw new Error('无法加载数据文件');
                }
                const data = await response.json();
                
                if (!data.title || !data.pattern_text || !data.pattern_json) {
                    throw new Error('数据格式不正确');
                }

                if (!data.pattern_json.total_rows || !Array.isArray(data.pattern_json.pattern)) {
                    throw new Error('pattern_json 格式不正确');
                }
                
                initialize(data.title, data.pattern_json);
            } catch (e) {
                console.error('加载数据失败:', e);
                document.getElementById('pattern-title').textContent = '加载失败';
                document.getElementById('instructions').innerHTML = 
                    `<div class="instruction-line" style="color: red;">
                        错误: ${e.message}<br>
                        请确保已运行 python knitting_parser.py 生成数据文件
                    </div>`;
            }
        }

        // 更新当前行显示
        function updateCurrentRow() {
            const rowCounter = document.getElementById('row-counter');
            const decrementButton = document.getElementById('decrementButton');
            const incrementButton = document.getElementById('incrementButton');

            rowCounter.textContent = currentRow;
            decrementButton.disabled = currentRow <= 1;
            incrementButton.disabled = currentRow >= patternData.total_rows;

            // 更新文本指示和图解高亮
            const elements = {
                instructions: document.querySelectorAll('.instruction-line'),
                patterns: document.querySelectorAll('.pattern-grid')
            };

            Object.entries(elements).forEach(([type, elements]) => {
                elements.forEach((el, index) => {
                    const rowNum = index + 1;
                    el.classList.remove('completed', 'active');
                    
                    if (rowNum < currentRow) {
                        el.classList.add('completed');
                    } else if (rowNum === currentRow) {
                        el.classList.add('active');
                        el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                });
            });
        }

        // 增加行数
        function incrementRow() {
            if (currentRow < patternData.total_rows) {
                currentRow++;
                updateCurrentRow();
            }
        }

        // 减少行数
        function decrementRow() {
            if (currentRow > 1) {
                currentRow--;
                updateCurrentRow();
            }
        }

        // 渲染编织说明
        function renderInstructionsFromJson(patternArr) {
            const container = document.getElementById('instructions');
            container.innerHTML = '';
            instructionLines = [];
            
            patternArr.forEach(row => {
                const div = document.createElement('div');
                div.className = 'instruction-line';
                
                const rowNumber = document.createElement('span');
                rowNumber.className = 'instruction-row-number';
                rowNumber.textContent = `${row.row_number}. `;
                
                const instructionText = document.createElement('span');
                instructionText.className = 'instruction-text';
                instructionText.textContent = row.instruction;
                
                div.appendChild(rowNumber);
                div.appendChild(instructionText);
                
                container.appendChild(div);
                instructionLines.push(div);
            });
        }

        // 渲染图解
        function renderPattern(data) {
            const patternElement = document.getElementById('pattern');
            patternElement.innerHTML = '';

            data.pattern.forEach(row => {
                const rowContainer = document.createElement('div');
                rowContainer.className = 'row-container';

                const rowNumber = document.createElement('div');
                rowNumber.className = 'row-number';
                rowNumber.textContent = row.row_number;
                rowContainer.appendChild(rowNumber);

                const rowGrid = document.createElement('div');
                rowGrid.className = 'pattern-grid';
                rowGrid.style.gridTemplateColumns = `repeat(${row.stitches_per_row}, 40px)`;

                row.stitches.forEach(stitch => {
                    const stitchElement = document.createElement('div');
                    stitchElement.className = 'stitch';
                    
                    const symbol = STITCH_SYMBOLS[stitch.stitch_type] || '?';
                    const color = STITCH_COLORS[stitch.stitch_type] || '#000000';
                    
                    stitchElement.textContent = symbol;
                    stitchElement.style.color = color;
                    stitchElement.title = `第${stitch.stitch_number}针: ${stitch.stitch_type}`;
                    
                    rowGrid.appendChild(stitchElement);
                });

                rowContainer.appendChild(rowGrid);
                patternElement.appendChild(rowContainer);
            });

            updateCurrentRow();
        }

        // 初始化函数
        function initialize(title, data) {
            document.getElementById('pattern-title').textContent = title;
            patternData = data;
            
            renderInstructionsFromJson(data.pattern);
            renderPattern(data);
            currentRow = 1;
            updateCurrentRow();
        }

        // 页面加载时加载数据
        window.onload = loadKnittingData;
    </script>
</body>
</html> 