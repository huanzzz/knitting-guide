<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编织图案可视化</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .pattern-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 1200px;
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .instructions-section {
            flex: 1;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .pattern-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .pattern-grid {
            display: grid;
            grid-gap: 1px;
            background-color: #ccc;
            padding: 1px;
            margin-left: 30px;
            opacity: 0.5;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .pattern-grid.active {
            opacity: 1;
            background-color: #a0a0a0;
            border: 2px solid #2196F3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
        }

        .row-container {
            display: flex;
            align-items: center;
            margin: 2px 0;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }

        .row-container:has(.pattern-grid.active) {
            background-color: #E3F2FD;
        }

        .row-number {
            width: 30px;
            text-align: right;
            padding-right: 10px;
            font-size: 14px;
            color: #666;
        }

        .stitch {
            width: 40px;
            height: 40px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        }

        .active .stitch {
            border-color: #90CAF9;
            background-color: #FAFAFA;
        }

        .pattern-title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .pattern-info {
            margin-top: 20px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
        }

        .instruction-line {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            color: #666;
        }

        .instruction-line:hover {
            background-color: #f5f5f5;
        }

        .instruction-line.active {
            background-color: #E3F2FD;
            color: #1976D2;
            font-weight: bold;
        }

        .debug-container {
            margin-bottom: 20px;
            width: 100%;
            max-width: 1200px;
        }

        .debug-container textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }

        .debug-container button {
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .debug-container button:hover {
            background: #1976D2;
        }

        .counter-section {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .counter-button {
            width: 50px;
            height: 50px;
            font-size: 24px;
            border: none;
            border-radius: 8px;
            background: #2196F3;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .counter-button:hover {
            background: #1976D2;
        }

        .counter-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .counter-number {
            font-size: 36px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }

        .instruction-line.completed {
            color: #999;
            opacity: 0.7;
        }

        .pattern-grid.completed {
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <textarea id="debugInput" placeholder="在此输入JSON数据进行调试"></textarea>
        <button onclick="updatePattern()">更新图案</button>
    </div>

    <div class="pattern-container">
        <div class="instructions-section">
            <h3>编织说明</h3>
            <div id="instructions"></div>
        </div>

        <div class="pattern-section">
            <h2 class="pattern-title">编织图案</h2>
            <div id="pattern"></div>
            <div class="pattern-info">
                总行数: <span id="totalRows">0</span>
            </div>
        </div>
    </div>

    <div class="counter-section">
        <button class="counter-button" onclick="decrementRow()" id="decrementButton">-</button>
        <div class="counter-number" id="row-counter">1</div>
        <button class="counter-button" onclick="incrementRow()" id="incrementButton">+</button>
    </div>

    <!-- 先引入配置文件 -->
    <script src="stitch_config.js"></script>
    <script>
        let currentRow = 1;
        let patternData = null;

        // 更新当前行显示
        function updateCurrentRow() {
            // 更新计数器
            document.getElementById('row-counter').textContent = currentRow;

            // 更新按钮状态
            document.getElementById('decrementButton').disabled = currentRow <= 1;
            document.getElementById('incrementButton').disabled = currentRow >= patternData.total_rows;

            // 更新文本指示
            const instructionElements = document.querySelectorAll('.instruction-line');
            instructionElements.forEach((el, index) => {
                if (index + 1 < currentRow) {
                    el.classList.add('completed');
                    el.classList.remove('active');
                } else if (index + 1 === currentRow) {
                    el.classList.remove('completed');
                    el.classList.add('active');
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    el.classList.remove('completed', 'active');
                }
            });

            // 更新图解高亮
            const patternRows = document.querySelectorAll('.pattern-grid');
            patternRows.forEach((row, index) => {
                if (index + 1 < currentRow) {
                    row.classList.add('completed');
                    row.classList.remove('active');
                } else if (index + 1 === currentRow) {
                    row.classList.remove('completed');
                    row.classList.add('active');
                    row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    row.classList.remove('completed', 'active');
                }
            });
        }

        // 增加行数
        function incrementRow() {
            if (currentRow < patternData.total_rows) {
                currentRow++;
                updateCurrentRow();
            }
        }

        // 减少行数
        function decrementRow() {
            if (currentRow > 1) {
                currentRow--;
                updateCurrentRow();
            }
        }

        // 渲染编织说明（从JSON数据）
        function renderInstructionsFromJson(patternArr) {
            const container = document.getElementById('instructions');
            container.innerHTML = '';
            
            patternArr.forEach(row => {
                const div = document.createElement('div');
                div.className = 'instruction-line';
                div.textContent = `第${row.row_number}行: ${row.instruction}`;
                container.appendChild(div);
            });
        }

        function renderPattern(data) {
            patternData = data;  // 保存数据供计数器使用
            const patternElement = document.getElementById('pattern');
            const totalRowsElement = document.getElementById('totalRows');

            // 清空现有内容
            patternElement.innerHTML = '';

            // 更新信息
            totalRowsElement.textContent = data.total_rows;

            // 渲染每一行
            data.pattern.forEach(row => {
                const rowContainer = document.createElement('div');
                rowContainer.className = 'row-container';

                // 添加行号
                const rowNumber = document.createElement('div');
                rowNumber.className = 'row-number';
                rowNumber.textContent = row.row_number;
                rowContainer.appendChild(rowNumber);

                // 创建该行的网格
                const rowGrid = document.createElement('div');
                rowGrid.className = 'pattern-grid';
                rowGrid.style.gridTemplateColumns = `repeat(${row.stitches_per_row}, 40px)`;

                // 添加每一针
                row.stitches.forEach(stitch => {
                    const stitchElement = document.createElement('div');
                    stitchElement.className = 'stitch';
                    
                    // 设置针法符号和颜色
                    const symbol = STITCH_SYMBOLS[stitch.stitch_type] || '?';
                    const color = STITCH_COLORS[stitch.stitch_type] || '#000000';
                    
                    stitchElement.textContent = symbol;
                    stitchElement.style.color = color;
                    
                    // 添加针法提示
                    stitchElement.title = `第${stitch.stitch_number}针: ${stitch.stitch_type}`;
                    
                    rowGrid.appendChild(stitchElement);
                });

                rowContainer.appendChild(rowGrid);
                patternElement.appendChild(rowContainer);
            });

            // 初始化计数器状态
            currentRow = 1;
            updateCurrentRow();
        }

        function validatePatternData(data) {
            if (!data || typeof data !== 'object') {
                throw new Error('数据格式错误：需要是一个对象');
            }
            if (typeof data.total_rows !== 'number') {
                throw new Error('数据格式错误：缺少 total_rows 或格式不正确');
            }
            if (!Array.isArray(data.pattern)) {
                throw new Error('数据格式错误：缺少 pattern 数组');
            }
            data.pattern.forEach((row, index) => {
                if (!row.row_number || !row.stitches_per_row || !Array.isArray(row.stitches)) {
                    throw new Error(`第 ${index + 1} 行数据格式错误`);
                }
                if (row.stitches.length !== row.stitches_per_row) {
                    throw new Error(`第 ${index + 1} 行的针数与 stitches_per_row 不匹配`);
                }
            });
            return true;
        }

        function updatePattern() {
            const debugInput = document.getElementById('debugInput');
            try {
                const data = JSON.parse(debugInput.value.trim());
                console.log('解析的数据:', data);
                
                // 验证数据格式
                validatePatternData(data);
                
                // 清空并重新渲染
                const patternElement = document.getElementById('pattern');
                patternElement.innerHTML = '';
                
                renderPattern(data);
                renderInstructionsFromJson(data.pattern);
                console.log('渲染完成');
            } catch (e) {
                console.error('错误:', e);
                alert('更新失败: ' + e.message);
            }
        }

        // 从knitting_data.json加载数据
        async function loadKnittingData() {
            try {
                const response = await fetch('knitting_data.json');
                if (!response.ok) {
                    throw new Error('无法加载数据文件');
                }
                const data = await response.json();
                
                // 使用JSON数据渲染编织说明
                if (data.pattern_json && data.pattern_json.pattern) {
                    renderInstructionsFromJson(data.pattern_json.pattern);
                }
                
                // 更新输入框和图案显示
                const debugInput = document.getElementById('debugInput');
                if (debugInput) {
                    debugInput.value = JSON.stringify(data.pattern_json, null, 2);
                }
                renderPattern(data.pattern_json);
            } catch (e) {
                console.error('加载数据失败:', e);
                alert('加载数据失败，使用示例数据');
                document.getElementById('instructions').innerHTML = '<div class="instruction-line">加载失败，使用示例数据</div>';
            }
        }

        // 页面加载时加载数据
        window.onload = function() {
            loadKnittingData();
        };
    </script>
</body>
</html> 